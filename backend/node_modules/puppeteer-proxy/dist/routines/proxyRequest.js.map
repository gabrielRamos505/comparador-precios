{"version":3,"file":"proxyRequest.js","names":["_util","require","_got","_interopRequireDefault","_toughCookie","_serializeError","_httpProxyAgent","_httpsProxyAgent","_utilities","_Logger","_getAllCookies","e","__esModule","default","log","Logger","child","namespace","defaultChromeHeaders","accept","appendDefaultChromeHeaders","request","nextHeaders","headers","host","URL","url","hostname","isNavigationRequest","proxyRequest","proxyRequestConfiguration","page","proxyUrl","startsWith","continue","debug","body","postData","method","puppeteerCookies","getAllCookies","cookies","cookieJar","CookieJar","deserializeSync","map","puppeteerCookie","formatPuppeteerCookieAsToughCookie","rejectPublicSuffixes","storeType","version","getCookieString","promisify","bind","setCookie","gotCookieJar","rawCookie","ignoreError","agent","http","HttpProxyAgent","https","HttpsProxyAgent","response","got","followRedirect","responseType","retry","throwHttpErrors","error","serializeError","abort","Error","respond","status","statusCode","proxyRequest0","_default","exports"],"sources":["../../src/routines/proxyRequest.js"],"sourcesContent":["// @flow\n\nimport {\n  promisify,\n} from 'util';\nimport type {\n  Request,\n} from 'puppeteer';\nimport got from 'got';\nimport {\n  CookieJar,\n} from 'tough-cookie';\nimport {\n  serializeError,\n} from 'serialize-error';\nimport HttpProxyAgent from 'http-proxy-agent';\nimport HttpsProxyAgent from 'https-proxy-agent';\nimport {\n  formatPuppeteerCookieAsToughCookie,\n} from '../utilities';\nimport type {\n  ProxyRequestConfigurationType,\n} from '../types';\nimport Logger from '../Logger';\nimport getAllCookies from './getAllCookies';\n\nconst log = Logger.child({\n  namespace: 'proxyRequest',\n});\n\nconst defaultChromeHeaders = {\n  accept: 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9',\n  'accept-encoding': 'gzip, deflate, br',\n  'accept-language': 'en',\n};\n\n/**\n * @see https://github.com/puppeteer/puppeteer/issues/5364\n */\nconst appendDefaultChromeHeaders = (request: Request) => {\n  let nextHeaders = {\n    ...request.headers(),\n    ...defaultChromeHeaders,\n    host: new URL(request.url()).hostname,\n  };\n\n  if (request.isNavigationRequest()) {\n    nextHeaders = {\n      ...nextHeaders,\n      'sec-fetch-mode': 'navigate',\n      'sec-fetch-site': 'none',\n      'sec-fetch-user': '?1',\n    };\n  } else {\n    nextHeaders = {\n      ...nextHeaders,\n      'sec-fetch-mode': 'no-cors',\n      'sec-fetch-site': 'same-origin',\n    };\n  }\n\n  return nextHeaders;\n};\n\nconst proxyRequest = async (proxyRequestConfiguration: ProxyRequestConfigurationType): Promise<void> => {\n  const {\n    page,\n    proxyUrl,\n    request,\n  } = proxyRequestConfiguration;\n\n  // e.g. data URI scheme\n  if (!request.url().startsWith('http://') && !request.url().startsWith('https://')) {\n    request.continue();\n\n    return;\n  }\n\n  const headers = appendDefaultChromeHeaders(request);\n\n  log.debug({\n    body: request.postData(),\n    headers,\n    method: request.method(),\n    url: request.url(),\n  }, 'making a request using HTTP proxy');\n\n  const puppeteerCookies = (await getAllCookies(page)).cookies;\n\n  const cookieJar = CookieJar.deserializeSync({\n    cookies: puppeteerCookies.map((puppeteerCookie) => {\n      return formatPuppeteerCookieAsToughCookie(puppeteerCookie);\n    }),\n    rejectPublicSuffixes: true,\n    storeType: 'MemoryCookieStore',\n    version: 'tough-cookie@2.0.0',\n  });\n\n  const getCookieString = promisify(cookieJar.getCookieString.bind(cookieJar));\n  const setCookie = promisify(cookieJar.setCookie.bind(cookieJar));\n\n  const gotCookieJar = {\n    getCookieString: (url) => {\n      return getCookieString(url);\n    },\n    setCookie: (rawCookie: string, url: string) => {\n      return setCookie(\n        rawCookie,\n        url,\n        {\n          ignoreError: true,\n        },\n      );\n    },\n  };\n\n  let agent;\n\n  if (proxyRequestConfiguration.agent) {\n    agent = proxyRequestConfiguration.agent;\n  } else if (proxyUrl) {\n    agent = {\n      http: new HttpProxyAgent(proxyUrl.http || proxyUrl),\n      https: new HttpsProxyAgent(proxyUrl.https || proxyUrl),\n    };\n  }\n\n  let response;\n\n  try {\n    response = await got(request.url(), {\n      agent,\n      body: request.postData(),\n      cookieJar: gotCookieJar,\n      followRedirect: false,\n      headers,\n      method: request.method(),\n      responseType: 'buffer',\n      retry: 0,\n      throwHttpErrors: false,\n    });\n  } catch (error) {\n    log.error({\n      error: serializeError(error),\n    }, 'could not complete HTTP request due to an error');\n\n    request.abort();\n\n    return;\n  }\n\n  if (!response) {\n    throw new Error('response object is not present.');\n  }\n\n  await request.respond({\n    body: response.body,\n    headers: response.headers,\n    status: response.statusCode,\n  });\n};\n\nexport default async (proxyRequestConfiguration: ProxyRequestConfigurationType) => {\n  try {\n    await proxyRequest(proxyRequestConfiguration);\n  } catch (error) {\n    log.error({\n      error: serializeError(error),\n    }, 'could not proxy request due to an error');\n\n    proxyRequestConfiguration.request.abort();\n  }\n};\n"],"mappings":";;;;;;AAEA,IAAAA,KAAA,GAAAC,OAAA;AAMA,IAAAC,IAAA,GAAAC,sBAAA,CAAAF,OAAA;AACA,IAAAG,YAAA,GAAAH,OAAA;AAGA,IAAAI,eAAA,GAAAJ,OAAA;AAGA,IAAAK,eAAA,GAAAH,sBAAA,CAAAF,OAAA;AACA,IAAAM,gBAAA,GAAAJ,sBAAA,CAAAF,OAAA;AACA,IAAAO,UAAA,GAAAP,OAAA;AAMA,IAAAQ,OAAA,GAAAN,sBAAA,CAAAF,OAAA;AACA,IAAAS,cAAA,GAAAP,sBAAA,CAAAF,OAAA;AAA4C,SAAAE,uBAAAQ,CAAA,WAAAA,CAAA,IAAAA,CAAA,CAAAC,UAAA,GAAAD,CAAA,KAAAE,OAAA,EAAAF,CAAA;AAE5C,MAAMG,GAAG,GAAGC,eAAM,CAACC,KAAK,CAAC;EACvBC,SAAS,EAAE;AACb,CAAC,CAAC;AAEF,MAAMC,oBAAoB,GAAG;EAC3BC,MAAM,EAAE,8HAA8H;EACtI,iBAAiB,EAAE,mBAAmB;EACtC,iBAAiB,EAAE;AACrB,CAAC;;AAED;AACA;AACA;AACA,MAAMC,0BAA0B,GAAIC,OAAgB,IAAK;EACvD,IAAIC,WAAW,GAAG;IAChB,GAAGD,OAAO,CAACE,OAAO,CAAC,CAAC;IACpB,GAAGL,oBAAoB;IACvBM,IAAI,EAAE,IAAIC,GAAG,CAACJ,OAAO,CAACK,GAAG,CAAC,CAAC,CAAC,CAACC;EAC/B,CAAC;EAED,IAAIN,OAAO,CAACO,mBAAmB,CAAC,CAAC,EAAE;IACjCN,WAAW,GAAG;MACZ,GAAGA,WAAW;MACd,gBAAgB,EAAE,UAAU;MAC5B,gBAAgB,EAAE,MAAM;MACxB,gBAAgB,EAAE;IACpB,CAAC;EACH,CAAC,MAAM;IACLA,WAAW,GAAG;MACZ,GAAGA,WAAW;MACd,gBAAgB,EAAE,SAAS;MAC3B,gBAAgB,EAAE;IACpB,CAAC;EACH;EAEA,OAAOA,WAAW;AACpB,CAAC;AAED,MAAMO,YAAY,GAAG,MAAOC,yBAAwD,IAAoB;EACtG,MAAM;IACJC,IAAI;IACJC,QAAQ;IACRX;EACF,CAAC,GAAGS,yBAAyB;;EAE7B;EACA,IAAI,CAACT,OAAO,CAACK,GAAG,CAAC,CAAC,CAACO,UAAU,CAAC,SAAS,CAAC,IAAI,CAACZ,OAAO,CAACK,GAAG,CAAC,CAAC,CAACO,UAAU,CAAC,UAAU,CAAC,EAAE;IACjFZ,OAAO,CAACa,QAAQ,CAAC,CAAC;IAElB;EACF;EAEA,MAAMX,OAAO,GAAGH,0BAA0B,CAACC,OAAO,CAAC;EAEnDP,GAAG,CAACqB,KAAK,CAAC;IACRC,IAAI,EAAEf,OAAO,CAACgB,QAAQ,CAAC,CAAC;IACxBd,OAAO;IACPe,MAAM,EAAEjB,OAAO,CAACiB,MAAM,CAAC,CAAC;IACxBZ,GAAG,EAAEL,OAAO,CAACK,GAAG,CAAC;EACnB,CAAC,EAAE,mCAAmC,CAAC;EAEvC,MAAMa,gBAAgB,GAAG,CAAC,MAAM,IAAAC,sBAAa,EAACT,IAAI,CAAC,EAAEU,OAAO;EAE5D,MAAMC,SAAS,GAAGC,sBAAS,CAACC,eAAe,CAAC;IAC1CH,OAAO,EAAEF,gBAAgB,CAACM,GAAG,CAAEC,eAAe,IAAK;MACjD,OAAO,IAAAC,6CAAkC,EAACD,eAAe,CAAC;IAC5D,CAAC,CAAC;IACFE,oBAAoB,EAAE,IAAI;IAC1BC,SAAS,EAAE,mBAAmB;IAC9BC,OAAO,EAAE;EACX,CAAC,CAAC;EAEF,MAAMC,eAAe,GAAG,IAAAC,eAAS,EAACV,SAAS,CAACS,eAAe,CAACE,IAAI,CAACX,SAAS,CAAC,CAAC;EAC5E,MAAMY,SAAS,GAAG,IAAAF,eAAS,EAACV,SAAS,CAACY,SAAS,CAACD,IAAI,CAACX,SAAS,CAAC,CAAC;EAEhE,MAAMa,YAAY,GAAG;IACnBJ,eAAe,EAAGzB,GAAG,IAAK;MACxB,OAAOyB,eAAe,CAACzB,GAAG,CAAC;IAC7B,CAAC;IACD4B,SAAS,EAAEA,CAACE,SAAiB,EAAE9B,GAAW,KAAK;MAC7C,OAAO4B,SAAS,CACdE,SAAS,EACT9B,GAAG,EACH;QACE+B,WAAW,EAAE;MACf,CACF,CAAC;IACH;EACF,CAAC;EAED,IAAIC,KAAK;EAET,IAAI5B,yBAAyB,CAAC4B,KAAK,EAAE;IACnCA,KAAK,GAAG5B,yBAAyB,CAAC4B,KAAK;EACzC,CAAC,MAAM,IAAI1B,QAAQ,EAAE;IACnB0B,KAAK,GAAG;MACNC,IAAI,EAAE,IAAIC,uBAAc,CAAC5B,QAAQ,CAAC2B,IAAI,IAAI3B,QAAQ,CAAC;MACnD6B,KAAK,EAAE,IAAIC,wBAAe,CAAC9B,QAAQ,CAAC6B,KAAK,IAAI7B,QAAQ;IACvD,CAAC;EACH;EAEA,IAAI+B,QAAQ;EAEZ,IAAI;IACFA,QAAQ,GAAG,MAAM,IAAAC,YAAG,EAAC3C,OAAO,CAACK,GAAG,CAAC,CAAC,EAAE;MAClCgC,KAAK;MACLtB,IAAI,EAAEf,OAAO,CAACgB,QAAQ,CAAC,CAAC;MACxBK,SAAS,EAAEa,YAAY;MACvBU,cAAc,EAAE,KAAK;MACrB1C,OAAO;MACPe,MAAM,EAAEjB,OAAO,CAACiB,MAAM,CAAC,CAAC;MACxB4B,YAAY,EAAE,QAAQ;MACtBC,KAAK,EAAE,CAAC;MACRC,eAAe,EAAE;IACnB,CAAC,CAAC;EACJ,CAAC,CAAC,OAAOC,KAAK,EAAE;IACdvD,GAAG,CAACuD,KAAK,CAAC;MACRA,KAAK,EAAE,IAAAC,8BAAc,EAACD,KAAK;IAC7B,CAAC,EAAE,iDAAiD,CAAC;IAErDhD,OAAO,CAACkD,KAAK,CAAC,CAAC;IAEf;EACF;EAEA,IAAI,CAACR,QAAQ,EAAE;IACb,MAAM,IAAIS,KAAK,CAAC,iCAAiC,CAAC;EACpD;EAEA,MAAMnD,OAAO,CAACoD,OAAO,CAAC;IACpBrC,IAAI,EAAE2B,QAAQ,CAAC3B,IAAI;IACnBb,OAAO,EAAEwC,QAAQ,CAACxC,OAAO;IACzBmD,MAAM,EAAEX,QAAQ,CAACY;EACnB,CAAC,CAAC;AACJ,CAAC;AAAC,MAAAC,aAAA,SAEoB9C,yBAAwD,IAAK;EACjF,IAAI;IACF,MAAMD,YAAY,CAACC,yBAAyB,CAAC;EAC/C,CAAC,CAAC,OAAOuC,KAAK,EAAE;IACdvD,GAAG,CAACuD,KAAK,CAAC;MACRA,KAAK,EAAE,IAAAC,8BAAc,EAACD,KAAK;IAC7B,CAAC,EAAE,yCAAyC,CAAC;IAE7CvC,yBAAyB,CAACT,OAAO,CAACkD,KAAK,CAAC,CAAC;EAC3C;AACF,CAAC;AAAA,IAAAM,QAAA,GAAAC,OAAA,CAAAjE,OAAA,GAAA+D,aAAA","ignoreList":[]}